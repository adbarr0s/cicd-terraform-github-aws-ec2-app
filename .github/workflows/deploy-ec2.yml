name: Deploy app to EC2

on:
  workflow_dispatch:
    inputs:
      EC2_HOST:
        description: "EC2 public IP or DNS"
        required: true
        type: string

  repository_dispatch:
    types: [deploy-app]

jobs:
  deploy:
    runs-on: ubuntu-latest

    env:
      EC2_HOST: ${{ github.event_name == 'repository_dispatch' && github.event.client_payload.EC2_HOST || github.event.inputs.EC2_HOST }}

    steps:
      - name: Mostrar IP de destino
        run: echo "Deploying to EC2_HOST=$EC2_HOST"

      - name: Checkout app code
        uses: actions/checkout@v4

      - name: Configure SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_SSH_KEY }}" > ~/.ssh/id_rsa
          chmod 600 ~/.ssh/id_rsa
          ssh-keyscan -H "$EC2_HOST" >> ~/.ssh/known_hosts

      - name: Preparar diretório da app no EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@"$EC2_HOST" "sudo mkdir -p /var/www/minhaapp && sudo chown -R \$USER:\$USER /var/www/minhaapp"

      - name: Sync code to EC2
        run: |
          rsync -avz --delete ./ ${{ secrets.EC2_USER }}@"$EC2_HOST":/var/www/minhaapp

      # AGORA sim: instalar Docker NA EC2
      - name: Instalar Docker na EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@"$EC2_HOST" << 'EOF'
            set -e

            # Detectar gestor de pacotes (Amazon Linux 2/2023 ou similar)
            if command -v dnf >/dev/null 2>&1; then
              sudo dnf update -y
              sudo dnf install -y docker
            elif command -v yum >/dev/null 2>&1; then
              sudo yum update -y
              sudo yum install -y docker
            else
              echo "Nem dnf nem yum encontrados. Verifica o SO da EC2."
              exit 1
            fi

            sudo systemctl enable docker
            sudo systemctl start docker
          EOF

      - name: Subir container Jenkins na EC2
        run: |
          ssh ${{ secrets.EC2_USER }}@"$EC2_HOST" << 'EOF'
            # Garantir que Docker está disponível
            docker --version || { echo "Docker não está instalado corretamente"; exit 1; }

            # Opcional: parar/remover container antigo
            sudo docker stop DevOpsJenkins || true
            sudo docker rm DevOpsJenkins || true

            # Puxar imagem e subir container
            sudo docker pull jenkins/jenkins:lts-jdk17
            sudo docker run -d -p 8082:8080 --name DevOpsJenkins jenkins/jenkins:lts-jdk17
          EOF
